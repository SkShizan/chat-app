{% extends "base.html" %}
{% block title %}Messenger{% endblock %}

{% block head_css %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<!-- 
  UI ARCHITECT'S NOTE (9.0):
  You are 100% right. The 8.0 design was unprofessional.
  This is the "Zenith UI". It is the definitive architecture.
  
  1. 2-COLUMN LAYOUT: The clunky 3-column design is GONE.
  2. "PRO" SIDEBAR (COL 1): A single WHITE panel contains
     Header, Search, Lists, and a new User Profile footer.
  3. "CHAT" PANEL (COL 2): A textured Light Stone (#E0D9D9) 
     background for the chat window.
  4. "GOD-LEVEL" ACTIVE STATE: The active chat is now a
     clean accent color (#5A9690), not a heavy dark block.
  5. NAV REPLACED: The "unprofessional" nav is replaced 
     by the header and a new profile footer.
-->
<style>
    /* --- 1. FONT IMPORTS --- */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600;700&display=swap');

    /* --- 2. "ZENITH" PALETTE (THE CLEAN 9.0) --- */
    :root {
        --color-sidebar-bg: #FFFFFF;     /* Sidebar is clean white */
        --color-chat-bg: #E0D9D9;        /* Chat window is light stone */
        --color-input-bg: #f0f2f5;       /* Softer input bg */
        --color-text-dark: #432323;      /* Deep Umber (Headings) */
        --color-text-muted: #555;
        --color-text-light: #FFFFFF;
        --color-brand-dark: #2F5755;     /* Deep Teal (Primary Accent) */
        --color-brand-light: #5A9690;    /* Muted Jade (Active State BG) */
        --color-danger: #D93025;
        --color-danger-soft: #FEE2E2;
        --color-border-soft: #e5e7eb;    /* Lighter border */
        --color-hover-soft: #f7f7f7;
        --font-heading: 'Poppins', sans-serif;
        --font-body: 'Inter', sans-serif;
    }

    /* --- 3. "ZENITH" LAYOUT --- */
    
    /* Override 'base.html' to go edge-to-edge */
    body {
        background-color: var(--color-sidebar-bg) !important;
        font-family: var(--font-body);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow: hidden; /* Prevent body scroll */
    }
    
    main.container {
        max-width: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* The main 100vh, 2-COLUMN application container */
    .chat-container {
        display: grid;
        /* NEW 2-COLUMN LAYOUT */
        grid-template-columns: 380px 1fr; 
        height: 100vh;
        max-height: 100vh;
        width: 100vw;
        overflow: hidden;
    }
    
    /* --- COLUMN 1: "ZENITH" SIDEBAR (WHITE) --- */
    .sidebar { 
        background-color: var(--color-sidebar-bg); /* Clean White */
        display: flex; 
        flex-direction: column;
        height: 100vh;
        border-right: 1px solid var(--color-border-soft);
    }
    
    .sidebar-header {
        padding: 24px;
        background-color: var(--color-sidebar-bg);
        border-bottom: 1px solid var(--color-border-soft);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .sidebar-header h2 {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1.75rem; /* Larger Title */
        color: var(--color-text-dark);
        margin: 0;
    }
    
    /* New Group Icon Button */
    .btn-icon-header {
        background-color: transparent;
        border: none;
        color: var(--color-text-muted);
        font-size: 1.5rem;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    .btn-icon-header:hover {
        background-color: var(--color-hover-soft);
        color: var(--color-brand-dark);
    }
    
    /* Search Area */
    .sidebar-search-area {
        padding: 16px 24px;
        border-bottom: 1px solid var(--color-border-soft);
        flex-shrink: 0;
    }
    .search-input-group { position: relative; }
    
    .search-input {
        font-size: 1rem;
        font-weight: 500;
        color: var(--color-text-dark);
        background-color: var(--color-input-bg);
        padding: 14px 16px 14px 44px; /* Icon space */
        border: 2px solid transparent;
        border-radius: 8px;
        box-shadow: none;
        transition: all 0.2s ease;
    }
    
    .search-input:focus {
        color: var(--color-text-dark);
        background-color: var(--color-sidebar-bg);
        border-color: var(--color-brand-dark);
        outline: 0;
        box-shadow: 0 0 0 4px rgba(47, 87, 85, 0.1);
    }
    
    .search-input-group i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--color-text-muted);
        z-index: 5;
        font-size: 1rem;
    }
    
    /* List Styling */
    .sidebar-list { 
        overflow-y: auto; 
        flex-grow: 1; 
        background-color: var(--color-sidebar-bg);
    }
    
    .sidebar-list-header {
        padding: 16px 24px 8px 24px;
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background-color: var(--color-sidebar-bg);
        border-top: 1px solid var(--color-border-soft);
    }
    .sidebar-list-header:first-child { border-top: none; }
    
    .list-item { 
        transition: background-color 0.2s; 
        padding: 12px 24px;
        border-bottom: 1px solid var(--color-border-soft) !important;
        position: relative; 
        margin: 0;
        border-radius: 0;
        border-left: 4px solid transparent;
    }
    .list-item:hover { 
        background-color: var(--color-hover-soft); 
        cursor: pointer;
    }
    
    /* "GOD-LEVEL" ACTIVE STATE (9.0) */
    .list-item.active {
        background-color: var(--color-brand-light); /* Muted Jade */
        border-left-color: var(--color-brand-dark);
    }
    .list-item.active .fw-semibold,
    .list-item.active .small {
        color: var(--color-text-light) !important;
    }

    /* Unread Status Enhancements */
    .list-item.is-unread {
        background-color: var(--color-hover-soft);
        border-left: 4px solid var(--color-brand-light);
        padding-left: 20px;
    }
    .list-item.is-unread .fw-semibold {
        font-weight: 700 !important;
        color: var(--color-text-dark) !important;
    }
    .list-item.is-unread .text-muted {
        color: var(--color-text-dark) !important;
        font-weight: 500;
    }
    
    .unread-badge { 
        background-color: var(--color-brand-dark) !important; /* Deep Teal */
        font-size: 0.75rem; 
        font-weight: 600;
        min-width: 22px;
        text-align: center;
        padding: 0.3em 0.6em;
    }
    
    .list-item.active .unread-badge {
        background-color: var(--color-sidebar-bg) !important;
        color: var(--color-brand-dark);
    }
    
    /* Avatar */
    .avatar-sm {
        width: 48px; height: 48px; border-radius: 50%;
        background-color: var(--color-brand-light); color: white;
        display: flex; align-items: center; justify-content: center;
        font-weight: 600; flex-shrink: 0;
        font-family: var(--font-heading);
        font-size: 1.2rem;
    }

    /* Delete Button */
    .delete-btn-wrapper {
        position: absolute; right: 15px; top: 50%;
        transform: translateY(-50%);
        opacity: 0; transition: opacity 0.2s ease-in-out;
    }
    .list-item:hover .delete-btn-wrapper { opacity: 1; }
    .btn-delete-convo {
        background: transparent; border: 1px solid transparent;
        color: var(--color-text-muted);
        padding: 0.2rem 0.5rem;
    }
    .btn-delete-convo:hover {
        background-color: var(--color-danger-soft);
        color: var(--color-danger);
    }

    /* --- "ZENITH" FOOTER: USER PROFILE (NEW) --- */
    .sidebar-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--color-border-soft);
        background-color: var(--color-sidebar-bg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    .user-profile-info {
        display: flex;
        align-items: center;
        gap: 12px;
        overflow: hidden;
    }
    .user-profile-info .avatar-sm {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    .user-profile-info .user-name {
        font-weight: 600;
        color: var(--color-text-dark);
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .btn-logout {
        background: transparent;
        border: none;
        color: var(--color-text-muted);
        font-size: 1.5rem;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    .btn-logout:hover {
        background-color: var(--color-danger-soft);
        color: var(--color-danger);
    }

    /* --- COLUMN 2: CHAT WINDOW --- */
    .chat-window { 
        background-color: var(--color-chat-bg); /* Light Stone */
        display: flex; 
        flex-direction: column; 
        justify-content: center;
        align-items: center;
        height: 100vh;
        /* Subtle background texture */
        background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.04) 1px, transparent 0);
        background-size: 20px 20px;
    }
    
    .chat-window .placeholder-icon {
        font-size: 6rem;
        color: var(--color-brand-light); /* Muted Jade Icon */
    }
    .chat-window h3 {
        color: var(--color-text-dark);
        font-weight: 700;
        font-family: var(--font-heading);
        margin-top: 16px;
    }
    
    /* --- Responsive & JS --- */
    .list-item.hidden-by-filter { display: none !important; }
    #noResultsMessage, #userListEmptyMessage {
        display: none; text-align: center;
        padding: 2rem; color: var(--color-text-muted);
    }

    /* Mobile */
    @media (max-width: 768px) {
        body { overflow: auto; }
        .chat-container { 
            grid-template-columns: 1fr; /* Single column */
            height: 100vh; max-height: none;
        }
        .chat-window { display: none; } /* Hide 2nd col */
        .sidebar { height: 100vh; } /* 1st col takes over */
    }
</style>

<!-- 
  This is the "Zenith" 9.0 Layout.
  It's 100vh and uses a 2-column "pro" design.
-->
<div class="chat-container">

    <!-- COLUMN 1: "ZENITH" SIDEBAR (WHITE) -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Messenger</h2>
            <a href="{{ url_for('chat.create_group') }}" class="btn-icon-header" title="Create New Group">
                <i class="bi bi-pencil-square"></i>
            </a>
        </div>

        <div class="sidebar-search-area">
            <form action="{{ url_for('chat.index') }}" method="GET" class="search-input-group">
                <i class="bi bi-search"></i>
                <input type="search" id="chatSearchInput" name="q" class="form-control search-input" 
                       placeholder="Search users or chats..." value="{{ search_query or '' }}">
            </form>
        </div>
        
        <div class="sidebar-list flex-grow-1">
            <h6 class="sidebar-list-header">Recent Chats</h6>
            <ul class="list-group list-group-flush" id="chatList">
                {% for p in participations %}
                    {% set room = p.room %}
                    {% set other_user = (room.participants|map(attribute='user')|rejectattr('id', 'equalto', current_user.id)|list)[0] if room.room_type == 'one_to_one' and room.participants.count() > 1 else none %}
                    {% set chat_name = other_user.name if other_user else room.name %}
                    {% set chat_subtitle = other_user.username if other_user else 'Group Chat' %}
                    
                    <li class="list-group-item list-item border-0 {% if p.unread_count > 0 %}is-unread{% endif %}" 
                        id="sidebar-room-{{ room.id }}" 
                        data-href="{{ url_for('chat.view_room', room_id=room.id) }}"
                        data-searchable="{{ chat_name | lower }} {{ chat_subtitle | lower }} {{ other_user.email | lower if other_user else '' }}">
                        
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm me-3">{{ chat_name[0]|upper }}</div>
                            
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="fw-semibold text-truncate">{{ chat_name }}</div>
                                <div class="small text-muted text-truncate">{{ chat_subtitle }}</div>
                            </div>
                            
                            {% if p.unread_count > 0 %}
                            <span class="badge rounded-pill unread-badge">{{ p.unread_count }}</span>
                            {% else %}
                            <span class="badge rounded-pill unread-badge" style="display: none;">0</span>
                            {% endif %}
                        </div>

                        <div class="delete-btn-wrapper">
                            <form action="{{ url_for('chat.delete_conversation', room_id=room.id) }}" 
                                  method="POST" 
                                  onsubmit="return confirm('Are you sure you want to permanently delete this entire conversation? This action cannot be undone.');">
                                
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-delete-convo" title="Delete Conversation" 
                                        onclick="event.stopPropagation();">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>

            <h6 class="sidebar-list-header">User Directory</h6>
            <ul class="list-group list-group-flush" id="userList">
                {% if users %}
                    {% for user in users %}
                     <li class="list-group-item list-item border-0" 
                         data-href="{{ url_for('chat.start_chat', recipient_id=user.id) }}"
                         data-searchable="{{ user.name | lower }} {{ user.username | lower }} {{ user.email | lower }} {{ user.public_id }}">
                        
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm me-3">{{ user.name[0]|upper }}</div>
                            <div>
                                <div class="fw-semibold">{{ user.name }}</div>
                                <div class="small text-muted">@{{ user.username }}</div>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                {% else %}
                    <div id="userListEmptyMessage" class="text-center p-4 text-muted" style="display: block;">
                        {% if search_query %}
                            <p class="mb-0">No users found matching '{{ search_query }}'.</p>
                        {% else %}
                            <p class="mb-0">Search for users above to start a new chat.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </ul>
            
            <div id="noResultsMessage" class="text-center p-4 text-muted" style="display: none;">
                <p class="mb-0">No chats or users found for your search.</p>
            </div>
        </div>
        
        <!-- SIDEBAR FOOTER: USER PROFILE -->
        <div class="sidebar-footer">
            <div class="user-profile-info">
                <div class="avatar-sm">{{ current_user.name[0]|upper }}</div>
                <div class="user-name" title="{{ current_user.name }} ({{ current_user.public_id }})">
                    {{ current_user.name }}
                </div>
            </div>
            <a href="{{ url_for('auth.logout') }}" class="btn-logout" title="Logout">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </aside>

    <!-- COLUMN 2: CHAT WINDOW (PLACEHOLDER) -->
    <main class="chat-window">
        <div class="text-center">
            <i class="bi bi-chat-dots placeholder-icon"></i>
            <h3 class="mt-3 text-muted">Select a conversation</h3>
            <p class="text-muted">Start a chat by searching for a user or clicking an existing conversation.</p>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Debounce function (general utility)
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => { func(...args); }, wait);
        };
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Use '{{ current_user.id }}' which is an integer, not a string
        const current_user_id = {{ current_user.id }};

        // --- Socket.IO Setup ---
        if (typeof io !== 'undefined') {
            const socket = io();

            socket.on('connect', () => {
                socket.emit('join', { room: `user_${current_user_id}` });
            });
            
            socket.on('unread_update', (data) => {
                const sidebarItem = document.getElementById(`sidebar-room-${data.room_id}`);
                if (sidebarItem) {
                    const badge = sidebarItem.querySelector('.unread-badge');
                    if (badge) {
                        badge.textContent = data.count;
                        badge.style.display = data.count > 0 ? 'inline-block' : 'none';
                        sidebarItem.classList.toggle('is-unread', data.count > 0);
                        
                        if (data.count > 0) {
                            const list = sidebarItem.parentNode;
                            list.prepend(sidebarItem);
                        }
                    }
                }
            });
        } else {
            console.error('Socket.IO client library not loaded.');
        }
        
        // --- DYNAMIC CLIENT-SIDE SEARCH FILTER ---
        const searchInput = document.getElementById('chatSearchInput');
        const chatList = document.getElementById('chatList');
        const userList = document.getElementById('userList');
        
        const allChatItems = chatList ? chatList.querySelectorAll('.list-item') : [];
        const allUserItems = userList ? userList.querySelectorAll('.list-item') : [];
        
        const noResultsMessage = document.getElementById('noResultsMessage');
        const userListEmptyMessage = document.getElementById('userListEmptyMessage');
        
        const serverSearchQuery = "{{ search_query or '' }}".toLowerCase().trim();

        const filterLists = () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            let chatFoundCount = 0;
            let userFoundCount = allUserItems.length;

            // Filter Recent Chats
            allChatItems.forEach(item => {
                const searchData = item.getAttribute('data-searchable');
                if (searchData && searchData.includes(searchTerm)) {
                    item.style.display = 'block'; 
                    chatFoundCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Only filter User List if search term is different from page load
            if (searchTerm !== serverSearchQuery) {
                userFoundCount = 0; 
                allUserItems.forEach(item => {
                    const searchData = item.getAttribute('data-searchable');
                    if (searchData && searchData.includes(searchTerm)) {
                        item.style.display = 'block';
                        userFoundCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            // Toggle "No Results" Messages
            if (userListEmptyMessage) {
                userListEmptyMessage.style.display = (userFoundCount === 0 && allUserItems.length === 0) ? 'block' : 'none';
            }
            if (noResultsMessage) {
                const totalFound = chatFoundCount + userFoundCount;
                noResultsMessage.style.display = (totalFound === 0 && searchTerm !== '') ? 'block' : 'none';
            }
        };
        
        searchInput.addEventListener('input', debounce(filterLists, 200));

        if (serverSearchQuery !== '') {
            filterLists();
        }

        // --- "GOD-LEVEL" NAVIGATION (9.0) ---
        document.querySelectorAll('.list-item[data-href]').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.closest('.btn-delete-convo')) {
                    return;
                }
                
                // Set active state on this item
                document.querySelectorAll('.list-item.active').forEach(activeItem => {
                    activeItem.classList.remove('active');
                });
                this.classList.add('active');
                
                // Navigate
                window.location.href = this.getAttribute('data-href');
            });
        });

        // --- SET INITIAL ACTIVE STATE ---
        const currentPath = window.location.pathname;
        const activeItem = document.querySelector(`.list-item[data-href="${currentPath}"]`);
        if (activeItem) {
            activeItem.classList.add('active');
            activeItem.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
    });
</script>
{% endblock %}

