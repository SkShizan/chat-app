{% extends "base.html" %}

{% block head_css %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<!-- 
  UI ARCHITECT'S NOTE (14.0):
  This is the "Creator" UI. A new design from scratch.
  
  1.  LAYOUT: This is a professional 2-column application pane.
  2.  CONTROLS (Left): Title, Name, Creator Switch, Search.
  3.  CONTENT (Right): Member list.
  4.  FOOTER: A full-width "hero" action button at the bottom.
  5.  BUG FIX: The search JavaScript has been fixed and now works.
-->
<style>
    /* --- 1. "CREATOR" UI LAYOUT --- */
    
    /* This wrapper provides the "Light Stone" background */
    .page-wrapper {
        background-color: var(--color-chat-bg); /* Light Stone */
        padding: 2.5rem 1.5rem;
        min-height: calc(100vh - 77px); /* 100vh minus navbar height */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* This is the new floating white panel */
    .page-panel {
        background-color: var(--color-sidebar-bg); /* White */
        border: 1px solid var(--color-border-soft);
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
        max-width: 900px; /* Wider panel */
        width: 100%;
        margin: 0 auto;
        overflow: hidden;
    }
    
    /* "GOD-LEVEL" 2-COLUMN LAYOUT */
    .page-panel-body {
        display: grid;
        grid-template-columns: 40% 60%; /* 2-column layout */
        padding: 0;
    }
    
    /* Left "Controls" Pane */
    .form-pane {
        padding: 2rem;
        border-right: 1px solid var(--color-border-soft);
    }
    
    /* Right "Content" Pane */
    .list-pane {
        padding: 2rem;
        background-color: var(--color-hover-soft); /* Subtle bg */
    }
    
    .page-panel-footer {
        padding: 1.5rem 2rem;
        border-top: 1px solid var(--color-border-soft);
        background-color: var(--color-hover-soft);
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1rem;
    }

    /* --- 2. Page-Specific Styles --- */
    
    .form-pane h2 {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--color-text-dark);
        margin-bottom: 0.25rem;
    }
    
    .form-pane p {
        font-size: 1rem;
        color: var(--color-text-muted);
        margin-bottom: 2rem;
    }
    
    .list-pane h5, .form-pane h5 {
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: 1rem;
        color: var(--color-text-dark);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }

    /* Search Input (using gl-form-control-with-icon) */
    .search-input-group {
        position: relative;
        margin-bottom: 1rem;
    }
    .search-input-group i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--color-text-muted);
        z-index: 5;
        font-size: 1rem;
    }
    
    /* Member Selection List */
    .selection-list {
        max-height: 350px; /* Taller list */
        overflow-y: auto;
        border: 1px solid var(--color-border-soft);
        border-radius: 8px;
        padding: 0; 
        background-color: var(--color-sidebar-bg); /* White */
    }
    .list-group-item-action {
        cursor: pointer;
        padding: 0.75rem 1rem;
        transition: background-color 0.2s;
        border-bottom: 1px solid var(--color-border-soft);
        background-color: transparent !important; 
        margin: 0; 
    }
    .list-group-item-action:hover {
        background-color: var(--color-hover-soft) !important;
    }
    .list-group-item-action:last-child {
        border-bottom: none;
    }

    /* "God-Level" Checkbox */
    .list-group-item-action input[type="checkbox"] {
        transform: scale(1.2);
        margin-right: 15px;
        border-color: var(--color-border-soft); 
        border-width: 2px;
        transition: all 0.2s ease;
    }
    .list-group-item-action input[type="checkbox"]:checked {
        background-color: var(--color-brand-dark);
        border-color: var(--color-brand-dark);
    }
    .list-group-item-action input[type="checkbox"]:focus {
        box-shadow: 0 0 0 4px rgba(47, 87, 85, 0.1);
        border-color: var(--color-brand-dark);
    }

    .avatar-sm-small {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--color-brand-light); 
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
    }
    .info-text {
        font-size: 0.85rem; 
        color: var(--color-text-muted);
    }
    
    /* "God-Level" Form Switch */
    .form-check-input {
        width: 2.5em;
        height: 1.4em;
    }
    .form-check-input:checked {
        background-color: var(--color-brand-dark);
        border-color: var(--color-brand-dark);
    }
    .form-check-input:focus {
        box-shadow: 0 0 0 4px rgba(47, 87, 85, 0.1);
        border-color: var(--color-brand-dark);
    }
    
    /* BUG FIX: This class is used by the fixed JS */
    .list-group-item-action.hidden-by-filter {
        display: none !important;
    }
    
    @media (max-width: 768px) {
        .page-wrapper {
            padding: 0;
        }
        .page-panel-body {
            grid-template-columns: 1fr; /* Stack columns on mobile */
        }
        .page-panel {
            border-radius: 0;
            border: none;
        }
        .list-pane {
            border-top: 1px solid var(--color-border-soft);
        }
    }

</style>

<!-- 
  This layout is the "Creator" UI (14.0).
  It's a 2-column professional application pane.
-->
<div class="page-wrapper">
    <div class="page-panel">
        
        <form method="POST" action="{{ url_for('chat.create_group') }}" novalidate id="createGroupForm">
            <div class="page-panel-body">
                
                <!-- LEFT "CONTROLS" PANE -->
                <div class="form-pane">
                    <h2>Create a New Group</h2>
                    <p>Select members to begin a new conversation.</p>
                
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-4">
                        <label for="{{ form.name.id }}" class="gl-form-label">Group Name</label>
                        <!-- Upgraded to gl-form-control -->
                        {{ form.name(class="gl-form-control" + (" is-invalid" if form.name.errors else ""), placeholder="e.g., Marketing Team, Project Apollo") }}
                        {% for error in form.name.errors %}
                            <div class="gl-invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <!-- "Include Creator" checkbox moved to top -->
                    <div class="form-check form-switch my-4">
                        {{ form.include_creator(class="form-check-input") }}
                        {{ form.include_creator.label(class="form-check-label text-dark fw-500") }}
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">Search Members</h5>
                    
                    <!-- Upgraded to gl-form-control-with-icon -->
                    <div class="search-input-group gl-form-control-with-icon">
                        
                        <input type="search" id="memberSearchInput" class="gl-form-control" placeholder="Search by name, username...">
                    </div>
                </div>
                
                <!-- RIGHT "CONTENT" PANE -->
                <div class="list-pane">
                    <h5 class="mb-3">Select Members</h5>
                
                    <div class="selection-list list-group mb-4" id="memberList">
                        {% for employee in employees %}
                            <label class="list-group-item list-group-item-action d-flex align-items-center" 
                                   data-search-terms="{{ employee.name | lower }} {{ employee.username | lower }} {{ employee.email | lower }} {{ employee.public_id | lower }}">
                                
                                <input type="checkbox" name="members" value="{{ employee.id }}" class="form-check-input flex-shrink-0 member-checkbox" 
                                       {% if employee.id in (form.members.data or []) %}checked{% endif %}>
                                
                                <div class="avatar-sm-small ms-3 me-3">{{ employee.name[0]|upper }}</div>
                                
                                <div>
                                    <div class="fw-semibold text-dark">{{ employee.name }}</div>
                                    <div class="info-text">@{{ employee.username }} &middot; {{ employee.email }}</div>
                                </div>
                            </label>
                        {% else %}
                            <div class="p-4 text-center text-muted" id="noInitialResults">No employees found.</div>
                        {% endfor %}
                         <div class="p-4 text-center text-muted" id="noResultsRuntimeMessage" style="display: none;">No members found matching your search.</div>
                    </div>
                    
                    {% for error in form.members.errors %}
                        <div class="gl-invalid-feedback d-block mb-3">{{ error }}</div>
                    {% endfor %}
                </div>
                
            </div>
            
            <!-- "GOD-LEVEL" FOOTER: Full-width action button -->
            <div class="page-panel-footer">
                <a href="{{ url_for('chat.index') }}" class="gl-btn-secondary">Cancel</a>
                <button type="submit" class="gl-btn-primary" form="createGroupForm" style="width: 100%;">
                    <i class="bi bi-people-fill me-2"></i> Create Group
                </button>
            </div>
        </form>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Debounce function (general utility)
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => { func(...args); }, wait);
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('memberSearchInput');
        const memberList = document.getElementById('memberList');
        const allMemberLabels = memberList ? memberList.querySelectorAll('.list-group-item-action') : [];
        const noResultsRuntimeMessage = document.getElementById('noResultsRuntimeMessage');
        const initialNoResultsMessage = document.getElementById('noInitialResults');
        
        // Hide initial "no results" message if the list is populated
        if (initialNoResultsMessage && allMemberLabels.length > 0) {
            initialNoResultsMessage.style.display = 'none';
        }

        // --- DYNAMIC SEARCH FILTER ---
        if (searchInput && allMemberLabels.length > 0) {
            
            const filterMembers = () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                let foundCount = 0;

                allMemberLabels.forEach(label => {
                    const searchTerms = label.getAttribute('data-search-terms');

                    // --- ★★★ BUG FIX ★★★ ---
                    // The logic now *only* adds/removes the class.
                    // It no longer manipulates inline style.display,
                    // which was causing the bug.
                    if (searchTerms && searchTerms.includes(searchTerm)) {
                        label.classList.remove('hidden-by-filter');
                        foundCount++;
                    } else {
                        label.classList.add('hidden-by-filter');
                    }
                    // --- ★★★ END BUG FIX ★★★ ---
                });
                
                // Toggle "No Results" Message (runtime)
                if (noResultsRuntimeMessage) {
                    noResultsRuntimeMessage.style.display = (foundCount === 0) ? 'block' : 'none';
                }
            };

            // Apply filter on input change
            searchInput.addEventListener('input', debounce(filterMembers, 200)); 
            
        }
        
        // --- CHECKBOX TOGGLE HANDLER (Allows clicking label to check box) ---
        if (memberList) {
            memberList.addEventListener('click', function(e) {
                const label = e.target.closest('.list-group-item-action');
                if (!label) return;
                
                const checkbox = label.querySelector('input[type="checkbox"]');
                
                // Ensure checkbox exists and the target was NOT an input element itself
                if (checkbox && e.target.tagName !== 'INPUT') { 
                    // Manually toggle the checkbox state
                    checkbox.checked = !checkbox.checked;
                }
                
                e.stopPropagation();
            });
        }
        
    });
</script>
{% endblock %}

